(function(a){a.extend(a.fn,{tag:function(b){var c={minWidth:100,minHeight:100,defaultWidth:100,defaultHeight:100,maxHeight:null,maxWidth:null,save:null,remove:null,canTag:true,canDelete:true,autoShowDrag:false,autoComplete:null,defaultTags:null,clickToTag:true,draggable:true,resizable:true,showTag:"hover",showLabels:true,debug:false,clickable:false,click:null};var b=a.extend(c,b);return this.each(function(){var c=a(this);c.data("options",b);a(window).load(function(){c.wrap('<div class="jTagContainer" />');c.wrap('<div class="jTagArea" />');a("<div class='jTagLabels'><div style='clear:both'></div></div>").insertAfter(c.parent());a('<div class="jTagOverlay"></div>').insertBefore(c);container=c.parent().parent();overlay=c.prev();c.parent().css("backgroundImage","url("+c.attr("src")+")");c.parent().width(c.width());c.parent().height(c.height());c.parent().parent().width(c.width());c.hide();if(b.autoShowDrag){c.showDrag()}container.delegate(".jTagTag","mouseenter",function(){if(a(".jTagDrag",container).length==0){a(this).css("opacity",1);if(b.canDelete){a(".jTagDeleteTag",this).show()}a(this).find("span").show();c.disableClickToTag()}});container.delegate(".jTagTag","mouseleave",function(){if(a(".jTagDrag",container).length==0){if(b.showTag=="hover"){a(this).css("opacity",0);if(b.canDelete){a(".jTagDeleteTag",this).hide()}a(this).find("span").hide()}c.enableClickToTag()}});if(b.showLabels&&b.showTag!="always"){container.delegate(".jTagLabels label","mouseenter",function(){a("#"+a(this).attr("rel"),container).css("opacity",1).find("span").show();if(b.canDelete){a(".jTagDeleteTag",container).show()}});container.delegate(".jTagLabels label","mouseleave",function(){a("#"+a(this).attr("rel"),container).css("opacity",0).find("span").hide();if(b.canDelete){a(".jTagDeleteTag",container).hide()}})}if(b.canDelete){container.delegate(".jTagDeleteTag","click",function(){if(b.remove){b.remove(a(this).parent().parent().getId())}if(b.showLabels){a(".jTagLabels",container).find('label[rel="'+a(this).parent().parent().attr("id")+'"]').remove()}a(this).parent().parent().remove();c.enableClickToTag()})}if(b.clickable){container.delegate(".jTagTag","click",function(){if(b.click){b.click(a(this).find("span").html())}})}if(b.defaultTags){a.each(b.defaultTags,function(a,b){c.addTag(b.width,b.height,b.top,b.left,b.label,b.id)})}c.enableClickToTag()})})},hideDrag:function(){var b=a(this);var c=b.data("options");b.prev().removeClass("jTagPngOverlay");b.parent().parent().find(".jTagDrag").remove();if(c.showTag=="always"){b.parent().parent().find(".jTagTag").show()}b.enableClickToTag()},showDrag:function(b){var c=a(this);var d=c.parent().parent();var e=c.prev();c.disableClickToTag();var f=c.data("options");var g=function(b){var c=a(".jTagDrag",b);border=parseInt(c.css("borderTopWidth"));left_pos=parseInt(c.attr("offsetLeft"))+border;top_pos=parseInt(c.attr("offsetTop"))+border;return"-"+left_pos+"px -"+top_pos+"px"};if(a(".jTagDrag",e).length==1){return}if(!f.canTag){return}if(f.showTag=="always"){a(".jTagTag",e).hide()}a('<div style="width:'+f.defaultWidth+"px;height:"+f.defaultHeight+'px"class="jTagDrag"><div class="jTagSave"><div class="jTagInput"><input type="text" id="jTagLabel"></div><div class="jTagSaveClose"></div><div class="jTagSaveBtn"></div><div style="clear:both"></div></div>').appendTo(e);e.addClass("jTagPngOverlay");jtagdrag=a(".jTagDrag",e);jtagdrag.css("backgroundImage","url("+c.attr("src")+")");if(b){function h(a){var b=curtop=0;if(a.offsetParent){do{b+=a.offsetLeft;curtop+=a.offsetTop}while(a=a.offsetParent);return[b,curtop]}}pos=h(c.parent()[0]);x=Math.max(0,b.pageX-pos[0]-f.defaultWidth/2);y=Math.max(0,b.pageY-pos[1]-f.defaultHeight/2);if(x+jtagdrag.width()>c.parent().width()){x=c.parent().width()-jtagdrag.width()-2}if(y+jtagdrag.height()>c.parent().height()){y=c.parent().height()-jtagdrag.height()-2}}else{x=0;y=0}jtagdrag.css("top",y).css("left",x);if(f.autoComplete){a("#jTagLabel",d).autocomplete({source:f.autoComplete})}a(".jTagSaveBtn",d).click(function(){label=a("#jTagLabel",d).val();if(label==""){alert("The label cannot be empty");return}height=a(this).parent().parent().height();width=a(this).parent().parent().width();top_pos=a(this).parent().parent().attr("offsetTop");left=a(this).parent().parent().attr("offsetLeft");tagobj=c.addTag(width,height,top_pos,left,label);if(f.save){f.save(width,height,top_pos,left,label,tagobj)}});a(".jTagSaveClose",d).click(function(){c.hideDrag()});if(f.resizable){jtagdrag.resizable({containment:c.parent(),minWidth:f.minWidth,minHeight:f.minHeight,maxWidth:f.maxWidth,maxHeight:f.maxHeight,resize:function(){jtagdrag.css({backgroundPosition:g(e)})},stop:function(){jtagdrag.css({backgroundPosition:g(e)})}})}if(f.draggable){jtagdrag.draggable({containment:c.parent(),drag:function(){jtagdrag.css({backgroundPosition:g(e)})},stop:function(){jtagdrag.css({backgroundPosition:g(e)})}})}jtagdrag.css({backgroundPosition:g(e)})},addTag:function(b,c,d,e,f,g){var h=a(this);var i=h.data("options");var j=a(".jTagTag").length+1;tag=a('<div class="jTagTag" id="tag'+j+'"style="width:'+b+"px;height:"+c+"px;top:"+d+"px;left:"+e+'px;"><div style="width:100%;height:100%"><div class="jTagDeleteTag"></div><span>'+f+"</span></div></div>").appendTo(h.prev());if(g){tag.setId(g)}if(i.canDelete){h.parent().find(".jTagDeleteTag").show()}if(i.showTag=="always"){a(".jTagTag").css("opacity",1)}if(i.showLabels){a("<label rel='tag"+j+"'>"+f+"</label>").insertBefore(a(".jTagLabels div:last"))}h.hideDrag();return tag},setId:function(b){if(a(this).hasClass("jTagTag")){a(this).data("tagid",b)}else{alert("Wrong object")}},getId:function(b){if(a(this).hasClass("jTagTag")){return a(this).data("tagid")}else{alert("Wrong object")}},enableClickToTag:function(){var b=a(this);var c=b.data("options");if(c.clickToTag){b.parent().mousedown(function(a){b.showDrag(a);b.parent().unbind("mousedown")})}},disableClickToTag:function(){var b=a(this);var c=b.data("options");if(c.clickToTag){b.parent().unbind("mousedown")}}})})(jQuery)
